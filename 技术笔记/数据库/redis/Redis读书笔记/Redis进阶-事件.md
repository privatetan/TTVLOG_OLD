# Redis进阶-事件

redis是一个事件驱动程序，服务器需要处理两类事件

- ###### 文件事件：redis服务器进行网络通讯的Socket操作的抽象；

- ###### 时间事件：redis服务器中定时任务操作的抽象；

## 文件事件处理器

redis基于reactor模式（待研究）开发的网络事件处理器：被称为文件事件处理器。

- 文件事件处理器使用I/O多路复用（multiplexing）程序来同时监听多个套接字，根据套接字目前完成的任务来为套接字关联不同事件处理器；
- 当被监听的套接字准备好执行连接应答（accept ）、读取（read）、写入（write）、关闭（close）等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的文件事件处理器来处理这些事件。

虽然文件事件处理器以单线程方式运行．通过使用 IO多路复用程序来监听多个套接字，文件事件处理器既实现了高性能的网络通信模型，又可以很好地与 Redis 服务器中其他同样以单线程方式运行的模块进行对接，这保持了 Redis 内部单线程设计的简单性。

### 文件事件处理器构成

- ##### 套接字

  文件事件是对套接字操作的抽象； 

  每当一个套接字准备好执行连接应答 (accept)、写入、读取、 就会产生一个文件事件；

  因为一个文件服务器通常会连接多个套接字， 所以多个文件事件有可能会并发地出现。

- ##### I/O多路复用程序

  I/O多路复用程序负责监听多个套接字，并向文件时间分派器传送产生了实践的套接字；

  I/O多路复用程序会将产生事件的套接字放入队列，以有序、同步、每次一个套接字的方式向文件事件分派器传送套接字；

  当上一个产生的事件被处理完成后，I/O多路复用程序才会继续向文件事件分派器传送套接字。

- ##### 文件事件分派器

  文件时间分派器接受到传过来的套接字，根据套接字产生的事件类型，调用相应的事件处理器。

- ##### 事件处理器

  服务器会为执行不同任务的套接字关联不同的事件处理器；

  这些处理器是一个个函数，它们定义了某个事件发生时，服务器应该执行的动作。

### I/O多路复用程序的实现

redis的I/O多路复用程序的所有功能都是通过包装select、epoll、export和kqueue这些I/O多路复用程序来实现的。

redis为每个I/O多路复用函数库都实现了相同的API，所以I/O多路复用程序的底层实现是可以互换的。

### 文件事件的类型

I/O多路复用程序可以监听多个套接字的ae.h/AE_READABLE事件和ae.h/AE_ WRITABLE事件；

两个事件的产生时机：

- ##### 读事件：AE_READABLE事件

  当套接字变得可读时（客户端对套接字执行write操作，或者执行close操作）， 或者有新的可应答（acceptable）套接字出现时（客户端对服务器的监听套接字执行 connect操作）产生。

- ##### 写事件：AE_ WRITABLE事件

  当套接字变得可写时（客户端对套接字执行read操作）产生。

如果一个套接字又可读又可写的话，那么服务器将先读套接字，后写套接字。

### 文件事件处理器

Redis为文件事件编写了多个处理器，这些事件处理器分别用于实现不同的网络通信需求。

- ###### 连接应答处理器

  用于对连接服务器监听套接字的客户端进行应答；

  networking. c/acceptTcpHandler函数是Redis的连接应答处理器。

- ###### 命令请求处理器

  负责从套接字中读入客户端发送的命令请求内容；

  networking.c/readQueryFrom Client函数是Redis的命令请求处理器。

- ###### 命令回复处理器

  负责将服务器执行命令后得到的命令回复通过套接字返回给客户端；

  networking . c/sendReplyToClient函数是Redis的命令回复处理器。

## 时间事件处理器

### 时间事件类型

- ###### 定时事件：指定时间执行；

- ###### 周期事件：按指定时间周期执行；

  事件的类型由时间事件处理器返回值决定

  - ###### 定时事件：

    如果事件处理器返回ae.h/AE_NOMORE,那么这个事件为定时事件；

    该事件在达到一次之后就会被删除，之后不再到达。

  - ###### 周期事件：

    如果事件处理器返回一个非AE_NOMORE的整数值，那么这个事件为周期性时间；

    到达后，更新事件when属性实现周期性。

### 时间事件构成

- ###### id：服务器为事件生成的全局唯一ID（标识号）；

- ###### when：记录事件到达时间，精度为：毫秒级的UNIX时间戳；

- ###### timeProc：时间事件处理器，一个函数；当事件到达，服务器就会调用相应的处理器来处理事件。

### 时间事件处理器期的实现

服务器将所有的时间事件都放在一个无序的链表中；

每当时间事件执行器运行时，它就遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器。

## 事件的调度与执行

事件的调度和执行有函数ae.c/aeProcessEvents决定

```c
def aeProcessEvents ():
   //获取到达时间离当前时间最接近的时间事件
   time_event = aeSearchNearestTimer()
     
   //计算最接近的时间事件距离到达还有多少毫秒
   remaind_ms = time_event.when - unix_ts_now()
     
   //如果事件已到达，那么remaind_ms的值可能为负数，将它设定为0
   if remaind_ms < 0: remaind_ms = 0
     
   //根据remaind_ms的值，创建timeval结构
   timeval = create_timeval_with_ms(remaind_ms)
     
   //阻塞并等待文件事件产生，最大阻塞时间由传入的timeval结构决定
   //如果remaind_ms的值为0,那么aeApiPoll调用之后马上返回，不阻塞
   aeApiPoll(timeval)
     
   //处理所有已产生的文件事件
   processFileEvents()
     
   //处理所有已到达的时间事件 
   processTimeEvents()
```

## 事件重点知识点

- Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件两类。 
- 文件事件处理器是基于Reactor模式实现的网络通信程序。

- 文件事件是对套接字操作的抽象：每次套接字变为可应答（acceptable ），可写 （writable ）或者可读（readable）时，相应的文件事件就会产生。

- 文件事件分为AE_READABLE事件（读事件）和AE_WRITABLE事件（写事件）两类。 
- 时间事件分为定时事件和周期性事件：定时事件只在指定的时间到达一次，而周期 性事件则每隔一段时间到达一次。

- 服务器在一般情况下只执行serverCron函数一个时间事件，并且这个事件是周期性事件。

- 文件事件和时间事件之间是合作关系，服务器会轮流处理这两种事件，并且处理事件的过程中也不会进行抢占。

- 时间事件的实际处理时间通常会比设定的到达时间晚一些。