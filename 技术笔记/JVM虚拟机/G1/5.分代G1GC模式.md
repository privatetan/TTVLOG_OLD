# 分代G1GC模式

## G1GC两种GC模式

- **纯G1GC模式**：垃圾优先垃圾回收

- **分代G1GC模式**：分代垃圾回收

  

## 分代G1GC特点

##### 与纯G1GC模式的不同点

- 区域是分代的
- 回收集合的选择是分代的

##### 区域划分

- 新生代区域
- 老年代区域

##### GC划分

- 完全新生代GC：新生代GC
- 部分新生代GC：老年代GC

两GC的主要区别在于回收集合的选择：

完全新生代GC，会将所有新生代区域选入回收集合；

部分新生代GC，会将所有新生代区域以及部分老年代区域选入回收集合。

两GC都会将所有新生代区域选入回收集合。



## 新生代区域

新生代还可以分为两部分

- ##### 创建区域

  存放刚创建的没有发生转移的对象；

- ##### 存活区域

  存放至少被转移过一次的对象。

**转移专用写屏障不会作用在新生代区域对象上**

因为在分代G1GC中，所有的新生代区域都会被选入回收集合，导致转移时所有对象引用都会被检查，所以新生代区域对象卡片不会记录在转移专用记忆集合中。



## 分代对象转移

年龄：存活对象保存了自己的转移次数；

晋升：年龄超过阈值，就会转移到老年代，称为晋升。



## 新生代GC执行过程

##### 完全新生代 GC

只会将所有新生代区域都选入回收集合，然后转移回收集合内的存活对象。

晋升的对象会被转移到老年代区域，其余对象则被转移到存活区域。

##### 部分新生代 GC

所有新生代区域外，及部分老年代区域选入回收集合，然后转移回收集合内的存活对象。

除了回收集合的选择方式，部分新生代 GC 和完全新生代 GC 的执行过程是一样的。



## 最大新生代区域数

**最大新生代区域数** ， 解决因新生代区域数太多，可能无法遵守用户设置的 GC 暂停时间上限，导致违反软实时性问题。

**最大新生代区域数计算方法**

- 完全新生代GC：在遵守 GC 暂停时间上限的前提下，尽量设置较大的值；
- 部分新生代GC：在遵守 GC 单位时间的前提下，尽量设置较小的值。



## GC切换

#### GC切换条件

G1GC选择GC算法时，一般会选择**部分新生代GC**，只有在使用完全新生代GC效率更高时，才会切换为完全新生代GC。

#### GC切换时机

在并发标记结束之后，与设置最大新生代区域数一样。

#### GC切换过程

1. 参考并发标记中标出的死亡对象个数，预测出下次部分新生代GC的转移效率；
2. 根据过去完全新生代GC的转移效率，预测出下次完全新生代GC的转移效率；
3. 如果预测出的完全新生代GC效率更高，则替换为完全新生代GC。



## GC执行时机

当新生代区域数达到上限时，会触发转移的执行。换句话说，通过调节最大新生代区域数，可以控制转移执行的时机。

当**转移完成**并通过以下 **4 项检查**之后，会开始执行并发标记。

1. 不在并发标记执行过程中
2. 并发标记的结果已被上次转移使用完；
3. 已经使用了一定量的堆内存（全部内存的45%以上）；
4. 相比上次转移完成后，堆内存的使用量有所增加。

并发标记过程中的所有暂停处理都需要遵守程序对于 GC 暂停处理的调度，以适当的时间间隔来执行。