# Eureka

## Eureka

Eureka是Netflix开发的服务发现框架，本身就是一个基于REST的服务。

Spring Cloud将它集成在其子项目spring-cloud-netflix中，用来实现服务的注册与发现功能。

## Eureka核心组件

- #### 服务注册中心（集群）
  
  - ###### 服务同步
    
    ```
    同一个服务的两个实例如果注册到不同的服务中心实例上，由于服务注册中心之间互相注册为服务，所以服务中心之间会互相转发注册请求服务给集群中的其他服务注册中心，从而实现服务注册中心之间的服务同步。
    ```
  
  - ###### 失效剔除
    
    ```
    sometime,服务实例会因为内存溢出、网络故障等不正常下线了。但是服务注册中心并没有收到“服务下线”的请求。
    
    那么为了解决这个问题，Eureka Server 在启动的时候会创建一个定时任务，默认每隔六十秒将当前清单中超时（默认九十秒）没有续约的服务剔除出去。
    ```
  
  - ###### 自我保护
    
    ```
    EurekaServer会统计心跳失败的比例在15分钟之内是否低于85%，如果出现低于的情况，EurekaServer会将这些实例保护起来，让其不过期，但是这样会让客户端拿到已经挂掉的服务实例，这就要求客户端必须要有容错机制（请求重试、断路器等）
    eureka.server.enable-self-preservation=false ： 关闭保护机制
    ```

- #### 服务提供者
  
  - ###### 服务注册
    
    ```
    服务提供者在启动的时候通过发送REST请求的方式将自己注册到EurekaServer上，同时带上自身元数据信息。
    
    Eureka Server接收到这个REST请求之后，将元数据的信息储存在一个双层结构的Map中，第一层map的key为服务名，第二层的key为具体服务的实例名。
    ```
  
  - ###### 服务续约（Renew）
    
    ```
    注册完服务之后，服务提供者会维持一个心跳告诉Eureka Server ：“我是一个活着的健康实例”，从而防止Eureka Server的“剔除任务”从服务列表中排除该实例。
    eureka.instance.lease-renewal-interval-in-seconds：心跳任务的调用时间，默认三十秒
    eureka.instance.lease-expiration-duration0in-seconds：服务时效时间，默认九十秒
    ```

- #### 服务消费者
  
  - ###### 获取服务
    
    ```
    服务消费者启动的时候会发送一个REST请求给注册中心，获取已注册的服务清单。
    为了性能考虑，EurekaServer会维护一份只读的服务清单来返回给客户端，同时该缓存清单会隔三十秒刷新一次。
    eureka.client.fetch-registry：获取服务，默认为true
    eureka.client.registry-fetch-interval-seconds：缓存清单的更新时间，默认三十秒
    ```
  
  - ###### 调用服务
    
    ```
    消费者获取清单之后，就可以获得服务者的实例名和元数据信息。
    Ribbon默认使用轮询的方式调用，从而实现客户端负载均衡
    ```
  
  - ###### 下线服务
    
    ```
    服务实例进行正常的关闭操作时，会触发一个服务下线的REST请求给Eureka Server，注册中心将该服务状态设置为下线(DOWN)，并且把下线事件传播出去。
    ```

通常情况下，服务提供者和服务消费者没有明确的划分，组件既可以是服务提供者也可是服务消费者。

## Eureka Server 如何实现高可用？

自我保护机制：将自己作为注册中心向其他服务注册中心注册自己，这样就可以形成一组互相注册的服务注册中心。

## Eureka保证AP

Eurek在设计时就优先保证可用性。

Eureka各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。

而Eureka的客户端在向某个Eureka注册或时如果发现连接失败，则会自动切换至其它节点，只要有一台Eureka还在，就能保证注册服务可用（保证可用性），只不过查到的信息可能不是最新的（不保证强一致性）。

除此之外，Eureka还有一种自我保护机制，见上。
