# InnoDB存储引擎

- ##### InnoDB存储引擎

- ##### InnoDB体系架构

## InnoDB存储引擎

InnoDB是MySQL5.5默认的存储引擎；

InnoDB是第一个完整支持ACID事务的MySQL存储引擎；

InnoDB的特点是：行锁设计、支持MVCC、支持外键、提供一致性非锁定读，能有效的使用内存和CPU资源；



## InnoDB体系架构

InnoDB存储引擎有多个内存块，这些内存块组成了内存池，主要负责如下工作：

- ##### 维护数据结构

  维护所有进程/线程需要访问的多个内部数据结构。

- ##### 缓存数据

  缓存磁盘上的数据，方便快速地读取，同时在对磁盘文件的数据修改之前在这里缓存。

- ##### 重做日志（redo log）缓存

  ......

### 后台线程

后台线程的主要作用是：负责刷新内存池中的数据，保证缓冲池的内存缓存是最新数据；

此外，将一修改的数据文件刷新到磁盘文件，同时保证在数据库发生异常时InnoDB能恢复到正常运行状态。

InnoDB存储引擎是多线程模型：后台会有多个不同的后台线程执行不同的任务；

- ###### Master Thread
  
  核心的后台线程，主要负责将缓冲池中的数据异步刷新到磁盘，保证数据一致性，包括脏页的刷新、合并插入缓冲、Undo页的回收等。

- ###### IO Thread
  
  InnoDB中使用了大量的AIO来处理IO请求，极大的提高数据库的性能；
  
  IO Thread则负责AIO的IO请求的回调处理。

- ###### Purge Thread
  
  Purge Thread用来回收事务提交后，已经被使用的Undo页。

- ###### Page Cleaner Thread
  
  作用：将之前版本中脏页的刷新操作都放入到单独的线程来完成；
  
  目的：减轻原Master Thread的工作及对于用户查询线程的阻塞，进一步提高InnoDB的性能。

### 内存

1. #### 缓冲池
   
   ***缓冲池，用于弥补磁盘I/O速度对数据库性能的影响，提高数据库整体性能。***
   
   读取页时，先将从磁盘读到的页“fix”到缓冲池，再次读取时，先去缓冲池查找，找不到再去磁盘读取；操作页时，先操作缓冲池中的页，然后通过一定频率以Ckeckpoint机制刷回磁盘。
   
   通过参数：innodb_buffer_pool_size来设置缓冲池大小。
   
   缓冲池中的数据页类型：索引页、数据页、undo页、插入缓冲、自适应哈希索引、InnoDB存储的锁信息、数据字典信息等。
   
2. #### LRU List、Free List、Flush List
   
   ##### LRU List，LRU页
   
   LRU算法：Least Recently Used，最近最少使用算法，根据数据的历史访问时间来进行淘汰数据，最近访问的数据放在链表头部，链表满时，删除尾部数据。[1]
   
   缓冲池是通过LRU（最近最少使用）算法来进行管理的，即最频繁使用的页在LRU List头部，最少使用的页在LRU List尾部，缓冲池不能存放新的页时，会释放LRU List尾端的页。
   
   在InnoDB中的LRU算法中，LRU List加入了`innodb_old_blocks_pct`参数（设置midpoint位置）和`innodb_old_blocks_time`参数（等待时间）来进一步管理LRU List，保证热点数据的存活率。
   
   ##### Free List，空闲页

   数据库刚启动时，LRU列表为空，页都存储在Free List中，当需要从缓冲池中获取数据时，先从Free List中查找是有否有可用的空闲页，若有则将该页从Free List中删除，放入到LRU List中。
   
   ##### Flash List，脏页列表
   
   脏页：LRU列表中被修改的页，即缓冲池中的页和磁盘上页的数据不一致，数据库会使用checkpoint机制将脏页刷新回磁。
   
3. #### 重做日志缓冲区（redo log buffer）
   
   InnoDB首先将重做日志信息放入重做日志缓冲区，饭后按照一定频率将其刷新到重做日志文件。
   
   ###### 在MySQL中为避免宕机等因素导致的数据丢失问题，普遍采用Write Ahead Log 策略，即当事务提交时，先写重做日志，再修改页。
   
   innodb_log_buffer_size设置重做缓冲区大小。

4. #### 额外内存池
   
   在InnoDB中，对内存的管理是通过内存堆（heap）的方式进行的。
   
   在对一些数据结构本身的内存进行分配时，需要从额外的内存池中申请，该区域内存不足时，会从缓冲区申请。

### Checkpoint技术

checkpoint（检查点）技术的目的：

- ###### 缩短数据库的恢复时间；
  
  宕机恢复时，对checkpoint后的重做日志进行恢复；

- ###### 缓冲池不够用时，将脏页刷新到磁盘；
  
  缓冲池不够用时，根据LRU算法会溢出最近最少使用页，若此页为脏页，则需强制执行Checkpoint，将脏页数据刷回磁盘；

- ###### 重做日志不可用时，刷新脏页。
  
  宕机恢复时，不需要某部分重做日志时，可以将该部分覆盖重用，如果还需要这部分重做日志时，就必须强制产生checkpoint，将缓冲池中的页刷新到当前重做日志。

### Master Thread工作方式

略

### InnoDB关键特性

- ###### 插入缓冲
  
  - Insert Buffer
  - Change Buffer

- ###### 两次写
  
  在重做日志前，需要实现页的副本，当写入失效发生时，先通过页的副本来还愿该页，再进行重做。

- ###### 自适应哈希索引
  
  哈希查找的时间复杂度为O(1)，B+树的查找次数取决于树的高度，在生产环境中，B+树的高度一般为3～4层，故需要3～4次查询；
  
  Inn0DB会监控对表上各索引页的查询，如果观察到建立哈希索引能带来速度提升，则会建立哈希索引，称之为自适应哈希索引（AHI）；
  
  AHI是通过缓冲池的B+树页构建的，简历速度很快不需要对整张表建哈希索引；
  
  InnoDB会自动根据访问频率和模式为某些热点页建立哈希索引。

- ###### 异步IO
  
  InnoDB采用异步IO的方式来处理磁盘操作，以提高操作性能。

- ###### 刷新邻接页
  
  提高传统机械硬盘IO操作性能，现代固态硬盘建议关闭此功能。



--------

参考文献

1. [常用缓存淘汰算法](https://melonshell.github.io/2020/02/07/ds_cache_eli/)