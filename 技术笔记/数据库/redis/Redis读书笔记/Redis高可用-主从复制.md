# Redis高可用-主从复制

## 主从复制

在redis中，用户可以通过执行replicaof（5.0之前使用slaveof命令），或者设置replicaof选项，让服务器去复制另一台服务器：

- ##### 主服务器：被复制服务器；

- ##### 从服务器：对主服务器进行复制的服务器。

数据的复制是单向的，只能由主节点到从节点；

进行复制中的主从服务器双方的数据库将保存相同的数据，概念上讲这种现象称作“数据库状态一致”，简称“一致”。

## 主从复制的作用

- **读写分离**：读请求由主服务器和从服务器处理，写请求由主服务器处理，然后同步给从服务器。

- **数据冗余**：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。

- **故障恢复**：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。

- **负载均衡**：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。

- **高可用基石**：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。

### 在2.8版本之前只有全量复制，而2.8版本后有全量和增量复制：

## 旧版主从复制功能的实现

redis主从复制功能分为“同步”和“命令传播”两个操作：

- ###### 同步：sync，同步更新数据库状态
  
  将从服务器数据库状态更新至主服务器当前所处的数据库状态。

- ###### 命令传播：command propagate，主从数据状态不一致时，使主从服务器状态一致。
  
  同步完成后，主服务器数据库状态被修改，导致主从服务器状态不一致时，让主从服务器重新回到一致性状态。

### 同步（sync）

当服务器接收到replicaof命令进行主从复制时，从服务器首先要执行同步操作：将从服务器数据库状态更新至主服务器当前所处的数据库状态。

同步操作是由SYNC命令来完成的，SYNC命令执行步骤如下：

1. 从服务器 向 主服务器 发送SYNC命令；
2. 收到SYNC命令的主服务器执行bgsave命令，在后台生成RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令；
3. 主服务器执行完bgsave命令，将生成的RDB文件发送给从服务器；
4. 从服务器接收并载入RDB文件，将从服务器数据库状态更新至主服务器执行bgsave命令时的数据状态；
5. 主服务器将缓冲区的命令发送给从服务器，从服务器根据执行命令，并更新数据库状态。

### 命令传播（command propagate）

同步完成后，让主从服务器在主服务器修改后，数据库状态保持一致，主服务器需要对从服务器执行命令传播操作：

主服务器将自己执行的写命令（即造成主从数据库状态不一致的命令），发送给从服务器执行，以达到主从数据库状态一致。

### 旧版主从复制缺陷

主从复制可以分为两种情况

- **初次复制**：初次主从复制的同步与命令传播；
- **断线后重复制**：主从服务器因为网络异常导致断线，重新连接后的同步和命令传播。

##### 存在问题

在断线后重复制情况下，重新连接后，无论新增命令的多少都要进行一次SYNC命令的同步操作；

### SYNC命令的问题

SYNC命令是一个非常耗费资源的操作，每次执行，主服务器都要执行以下动作：

- 主服务器执行BGSAVE命令生成RDB文件，这个操作会消耗主服务器大量的CPU、内存和磁盘I/O资源；
- 主服务器需要将RDB文件发送给从服务器，这个操作会消耗主服务器大量的网络资源（带宽和流量），影响对其他命令的处理；
- 从服务器在处理RDB文件时，会阻塞主线程，而无法处理命令请求。

SYNC是非常消耗资源的操作，redis有必要在真正需要的时候才执行该操作。

## 新版主从复制的实现

为了解决旧版主从复制在处理断线重复制时的低效问题，redis从2.8开始使用PSYNC命令代替SYNC命令来执行复制时的同步操作。

PSYNC具有“完整重同步”和“部分重同步”两种模式：

- **完整重同步**：即全量同步复制，处理初次复制，步骤与SYNC一致；
- **部分重同步**：即增量同步复制，处理断线重复制，断线重连后，主服务器将短线后的写命令发送给从服务器，从服务器接收并执行后，就完成了数据库状态的同步。

### 部分重同步的实现

该功能由三个部分构成：

- 复制偏移量：主从服务器的复制偏移量；
- 复制积压缓冲区：主服务器的复制积压缓冲区；
- 服务器的运行ID；

#### 复制偏移量

主从服务器都会分别维护一个复制偏移量：

- 主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量的值加上N。
- 从服务器每次收到主服务器的N和字节的数据时，就将自己的复制偏移量的值加上N。

通过对比复制偏移量，就可以判断主从服务器是否处于一致状态。

#### 复制积压缓冲区

复制积压缓冲区是由主服务器维护的一个固定长度的先进先出（FIFO）队列，默认大小为1MB；

当主服务器进行命令传播时，它不仅会将写命令发送给所有服务器，还会将写命令放到复制积压缓冲区队列里面；

复制积压缓冲区里面会保存着一部分最近传播的写命令，并且复制积压缓冲区会为队列中的每个字节记录相应的复制偏移量。

当从服务器重新连接到主服务器时，从服务器会通过PSYNC命令将自己的复制偏移量offset发送给主服务器，主服务会根据从服务器的复制偏移量来进行同步操作。

复制积压缓冲区大小公式：second * write_size_per_second

- second：断线重连所需要的事件（秒）；
- write_size_per_second：主服务器每秒产生的写命令数量。

保险起见可将复制积压缓冲区设置为：2 * second * write_size_per_second。

#### 服务器运行ID

主从服务器都会有运行ID；

运行ID自动生成，由40个随机的16进制字符组成；

当主从服务器进行初次复制时，从服务器会保留主服务器传过来的运行ID，当断线重连时，从服务器会将保存的主服务器的运行ID发送给当前连接的主服务器：

- 若从服务器发送的和主服务器运行ID相同，则进行部分重同步操作；
- 反之，则进行完整重同步操作。

## 心跳检测

在命令传播阶段，从武器会议每秒一次的频率，向主服务器发送命令：

replconf ack <replication-offset>

replication_offset:从服务器当前的复制偏移量；

replconf ack 命令对于主从服务器三个作用：

- 检测主从服务器的网络连接状态；
- 辅助实现min-slaves配置选项；
- 检测命令丢失。

## 主从复制实现原理

复制功能实现步骤

1. #### 设置主服务器的地址和端口
   
   replicaof（slaveof）<master-ip> <master-port> ：
   
   该命令会将值保存在服务器状态的masterhost与masterport属性中；
   
   replicaof（slaveof）命令是一个异步操作，设置完主服务器的masterhost与masterport属性后，即返回OK，而复制工作是在OK返回之后开始执行的。

2. #### 建立套接字链接
   
   在replicaof（slaveof）命令执行之后，从服务器根据命令的IP地址与端口，创建连向主服务器的套接字连接。
   
   连接创建后，从服务将是主服务器的客户端：从服务器发送命令请求，主服务器执行请求并回复。

3. #### 发送PING命令
   
   从服务器成为主服务器的客户端后，第一件事就是向主服务器发送一个PING命令。
   
   PING命令的两个作用：
   
   - 检查套接字的读写状态是否正常；
   - 检查主服务器是否能正常处理命令请求。
   
   发送PING命令后，会遇到如下三种情况：
   
   - 网络连接不佳：从服务器不能在规定时间内读取主服务器的回复内容，需重新创建套接字连接。
   - 返回错误：主服务器无法处理从服务器的命令请求，需重新建立套接字连接；
   - 返回“PONG”回复，主从服务器之间网络正常，继续执行后续步骤。

4. #### 身份验证
   
   从服务器收到主服务器“PONG”回复之后，根据masterauth选项判断是否进行身份验证：
   
   - 从服务器设置了masterauth，则进行身份验证；
   - 反之，则不会进行身份验证。
   
   若需要进行身份验证，从服务器就会向主服务器发送一条AUTH命令，参数为masterauth选项的值。
   
   验证过程中所有的错误情况都会终止复制工作，并从创建套接字开始重新执行复制，知道身份验证通过，或者放弃复制操作。

5. #### 发送端口信息
   
   身份验证完毕，从服务器执行replconf  listening-port <port-number> 命令，向主服务器发送从服务器的监听端口号。

6. #### 同步
   
   从服务器向主服务器发送PSYNC命令，执行同步操作，并更新数据库状态与主服务器保持一致。
   
   同步之前，从服务器是主服务器的客户端；同步后，主从服务器都是对方的客户端，互相发送命令，这是命令传播的基础。

7. #### 命令传播
   
   当完成同步后，主从服务器就会进入命令传播阶段：主服务器向从服务器发送写命令，从服务器接收并执行写命令，主从服务器保持数据库状态一致。

## 主从复制重点知识点

- Redis 2.8以前的复制功能不能高效地处理断线后重复制情况，但Redis 2.8新添加的 部分重同步功能可以解决这个问题。

- 部分重同步通过复制偏移量、复制积压缓冲区、服务器运行ID三个部分来实现。

- 在复制操作刚开始的时候，从服务器会成为主服务器的客户端，并通过向主服务器 发送命令请求来执行复制步骤，而在复制操作的后期，主从服务器会互相成为对方 的客户端。

- 主服务器通过向从服务器传播命令来更新从服务器的状态，保持主从服务器一致， 而从服务器则通过向主服务器发送命令来进行心跳检测,以及命令丢失检测。